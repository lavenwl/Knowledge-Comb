##### 需求: 

现状: 用户在商户消费, 用户支付给商家现金全款, 或扫商家二维码支付支付全款

优化: 用户在商户分期支付.

##### 设计:  

1. 用户注册公众号, 申请额度, 扫商户支付二维码进行支付
2. 商户登录小程序, 扫描用户展示的二维码进行支付
3. 支付成功发送消息至用户与商户

##### 实现:

###### 概要:

1. 功能涉及多客户端实时交互, 使用websocket建立长连接解决此问题.
2. 涉及到发送消息通知, 使用RabbitMQ
3. 集群部署解决websocket的session管理问题, 使用redis管理链接状态

###### 细节:

第一种(用户主动扫商户支付二维码):

	1. 用户打开公众号, 点击扫一扫, 扫描商户的支付二维码(内容为storeCode)
 	2. 用户将二维码识别的门店编号, 同金额与其他信息传至后台生成支用订单
 	3. 获取支用订单详情, 包含分期还款信息, 选择支付方式进行支付(微信需要预支付)
 	4. 支付成功回调至服务器, 服务器根据用户商户信息发送支用状态消息通知(RabbitMQ)

第二种:(商户小程序扫描用户展示的二维码)

1. 用户打开公众号, 打开二维码页面, 此时建立websocket链接, 等待商家扫描结果, 页面1分钟刷新一次
2. 后台生成二维码图片(imageID), imageID为key, 用户相关信息为value保存redis, 管理用户websocket链接
3. 商户登录小程序, 打开扫一扫页面扫描用户展示的二维码, 输入收款金额提交后台, 建立websocket链接
4. 后台获取imageID, redis获取用户信息, 创建支用订单后, 通过websocket通知用户支用订单已生成, 待支付
5. 用户websocket实时接收到支用订单待支付的返回, 根据返回的支用订单号, 获取订单详情, 跳转支付页面
6. 根据websocket返回的用户一条转支付页面, 商户跳转支付中页面
7. 用户选择合适的支付方式进行支付
8. 支付成功后回调后端, 后端根据用户与商户相关信息发送支付状态通知消息(RabbitMQ)

​	

